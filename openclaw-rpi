#!/usr/bin/env bash
#
# openclaw-rpi â€” Provision a Raspberry Pi as an OpenClaw AI agent
#
set -euo pipefail

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Defaults (override via env or flags)
PI_USER="${PI_USER:-pi}"
PI_HOSTNAME="${PI_HOSTNAME:-openclaw-pi}"
OLLAMA_MODELS="${OLLAMA_MODELS:-qwen2.5:1.5b gemma2:2b}"
SKIP_DOCKER="${SKIP_DOCKER:-0}"
INSTALL_OLLAMA="${INSTALL_OLLAMA:-0}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

log()  { echo -e "${GREEN}âœ“${NC} $*"; }
info() { echo -e "${BLUE}â†’${NC} $*"; }
warn() { echo -e "${YELLOW}âš ${NC} $*"; }
err()  { echo -e "${RED}âœ—${NC} $*" >&2; }
header() { echo -e "\n${BOLD}${CYAN}$*${NC}\n"; }

ssh_cmd() {
    local ip="$1"; shift
    ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new "$PI_USER@$ip" "$@"
}

scp_to() {
    local ip="$1" src="$2" dst="$3"
    scp -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new "$src" "$PI_USER@$ip:$dst"
}

require_ip() {
    if [[ -z "${1:-}" ]]; then
        err "Missing Pi IP address"
        echo "Usage: $0 $CMD <ip-address>"
        exit 1
    fi
}

wait_for_ssh() {
    local ip="$1" max="${2:-30}"
    info "Waiting for SSH on $ip..."
    for i in $(seq 1 "$max"); do
        if ssh_cmd "$ip" "true" 2>/dev/null; then
            log "SSH connected"
            return 0
        fi
        printf "."
        sleep 2
    done
    err "Timeout waiting for SSH after $((max * 2))s"
    return 1
}

# â”€â”€â”€ Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_flash() {
    header "ðŸ”§ OpenClaw RPi â€” SD Card Preparation"

    echo "This wizard guides you through flashing Raspberry Pi OS."
    echo ""
    echo "1. Open Raspberry Pi Imager:"
    echo "   ${BOLD}brew install --cask raspberry-pi-imager && open -a 'Raspberry Pi Imager'${NC}"
    echo ""
    echo "2. Select:"
    echo "   â€¢ Device: Raspberry Pi 4"
    echo "   â€¢ OS: Raspberry Pi OS Lite (64-bit) â€” under 'Raspberry Pi OS (other)'"
    echo "   â€¢ Storage: Your SD card"
    echo ""
    echo "3. Click the Settings gear icon and configure:"
    echo "   â€¢ Hostname: ${BOLD}${PI_HOSTNAME}${NC}"
    echo "   â€¢ Enable SSH â†’ Use public key authentication"
    echo "   â€¢ Username: ${BOLD}${PI_USER}${NC}"
    if [[ -n "${WIFI_SSID:-}" ]]; then
        echo "   â€¢ WiFi SSID: ${BOLD}${WIFI_SSID}${NC}"
    else
        echo "   â€¢ WiFi: Configure your network credentials"
    fi
    echo "   â€¢ Timezone: $(date +%Z)"
    echo ""
    echo "4. Flash the card, insert into Pi, power on"
    echo ""
    echo "5. Find the Pi on your network:"
    echo "   ${BOLD}arp -na | grep -i 'b8:27:eb\|dc:a6:32\|e4:5f:01\|2c:cf:67\|d8:3a:dd'${NC}"
    echo "   or: ${BOLD}ping ${PI_HOSTNAME}.local${NC}"
}

cmd_provision() {
    local ip="$1"
    header "ðŸš€ OpenClaw RPi â€” Provisioning $PI_USER@$ip"

    wait_for_ssh "$ip"

    info "Uploading provisioning script..."
    scp_to "$ip" "$SCRIPT_DIR/scripts/provision.sh" "/tmp/openclaw-provision.sh"

    info "Running provisioning (this takes 10-15 minutes)..."
    ssh_cmd "$ip" "SKIP_DOCKER=$SKIP_DOCKER INSTALL_OLLAMA=$INSTALL_OLLAMA OLLAMA_MODELS='$OLLAMA_MODELS' bash /tmp/openclaw-provision.sh"

    log "Provisioning complete!"
    warn "The Pi needs to reboot for group changes (docker, zsh). Rebooting..."
    ssh_cmd "$ip" "sudo reboot" 2>/dev/null || true
    sleep 5
    wait_for_ssh "$ip" 60
    log "Pi is back online"
}

cmd_configure() {
    local ip="$1"
    header "âš™ï¸  OpenClaw RPi â€” Configuration $PI_USER@$ip"

    info "Uploading configuration script..."
    scp_to "$ip" "$SCRIPT_DIR/scripts/configure.sh" "/tmp/openclaw-configure.sh"

    info "Starting interactive configuration..."
    ssh -t -o ConnectTimeout=10 "$PI_USER@$ip" "bash /tmp/openclaw-configure.sh"
}

cmd_verify() {
    local ip="$1"
    header "ðŸ” OpenClaw RPi â€” Verification $PI_USER@$ip"

    local pass=0 fail=0

    check() {
        local name="$1" cmd="$2"
        if ssh_cmd "$ip" "$cmd" &>/dev/null; then
            log "$name"
            ((pass++))
        else
            err "$name"
            ((fail++))
        fi
    }

    check "SSH access"            "true"
    check "Node.js installed"     "source ~/.nvm/nvm.sh && node --version"
    check "npm available"         "source ~/.nvm/nvm.sh && npm --version"
    check "OpenClaw installed"    "source ~/.nvm/nvm.sh && which openclaw"
    check "Chromium installed"    "which chromium || which chromium-browser"
    check "Git installed"         "git --version"
    check "Zsh is default shell"  "[ \"\$SHELL\" = \"$(ssh_cmd "$ip" 'which zsh' 2>/dev/null)\" ]"

    if [[ "$SKIP_DOCKER" != "1" ]]; then
        check "Docker installed"  "docker --version"
        check "Docker running"    "docker ps"
    fi

    if [[ "${INSTALL_OLLAMA:-0}" == "1" ]]; then
        check "Ollama installed"  "which ollama"
        check "Ollama running"    "curl -sf http://localhost:11434/api/tags"
    fi

    # System info
    echo ""
    info "System info:"
    ssh_cmd "$ip" "
        echo \"  OS:     \$(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')\"
        echo \"  Arch:   \$(uname -m)\"
        echo \"  Kernel: \$(uname -r)\"
        echo \"  Memory: \$(free -h | awk '/Mem:/ {print \$2}') total, \$(free -h | awk '/Mem:/ {print \$7}') available\"
        echo \"  Disk:   \$(df -h / | awk 'NR==2 {print \$4}') free of \$(df -h / | awk 'NR==2 {print \$2}')\"
        echo \"  Uptime: \$(uptime -p)\"
    "

    echo ""
    if [[ $fail -eq 0 ]]; then
        log "All $pass checks passed!"
    else
        warn "$pass passed, $fail failed"
    fi
}

cmd_setup() {
    local ip="$1"
    header "ðŸŽ¯ OpenClaw RPi â€” Full Setup Pipeline"
    cmd_provision "$ip"
    cmd_configure "$ip"
    cmd_verify "$ip"
    echo ""
    log "Setup complete! SSH in: ${BOLD}ssh $PI_USER@$ip${NC}"
}

cmd_ssh() {
    local ip="$1"
    ssh -o StrictHostKeyChecking=accept-new "$PI_USER@$ip"
}

cmd_status() {
    local ip="$1"
    header "ðŸ“Š OpenClaw RPi â€” Status $ip"
    ssh_cmd "$ip" "
        source ~/.nvm/nvm.sh 2>/dev/null
        echo 'â”€â”€ OpenClaw â”€â”€'
        openclaw status 2>/dev/null || echo 'Not running'
        echo ''
        echo 'â”€â”€ System â”€â”€'
        echo \"Uptime: \$(uptime -p)\"
        echo \"Memory: \$(free -h | awk '/Mem:/ {printf \"%s / %s\", \$3, \$2}')\"
        echo \"Disk:   \$(df -h / | awk 'NR==2 {printf \"%s / %s (%s)\", \$3, \$2, \$5}')\"
        echo \"Load:   \$(cat /proc/loadavg | cut -d' ' -f1-3)\"
        echo \"Temp:   \$(vcgencmd measure_temp 2>/dev/null | cut -d= -f2 || echo 'N/A')\"
    "
}

cmd_logs() {
    local ip="$1"
    info "Tailing OpenClaw logs on $ip (Ctrl+C to stop)..."
    ssh_cmd "$ip" "journalctl --user -u openclaw -f 2>/dev/null || echo 'No systemd service found. Check: openclaw gateway status'"
}

cmd_update() {
    local ip="$1"
    header "ðŸ”„ OpenClaw RPi â€” Update $ip"
    ssh_cmd "$ip" "
        source ~/.nvm/nvm.sh
        echo 'â”€â”€ System packages â”€â”€'
        sudo apt-get update -qq && sudo apt-get upgrade -y -qq
        echo ''
        echo 'â”€â”€ OpenClaw â”€â”€'
        npm update -g openclaw 2>/dev/null || echo 'Update via: openclaw gateway update.run'
        echo ''
        echo 'â”€â”€ Ollama â”€â”€'
        curl -fsSL https://ollama.com/install.sh | sh 2>/dev/null || true
    "
    log "Update complete"
}

cmd_browser_test() {
    local ip="$1"
    header "ðŸŒ OpenClaw RPi â€” Browser Test $ip"
    ssh_cmd "$ip" "
        echo 'Testing Chromium headless...'
        CHROME=\$(which chromium 2>/dev/null || which chromium-browser 2>/dev/null)
        if [ -z \"\$CHROME\" ]; then
            echo 'âœ— Chromium not found'
            exit 1
        fi
        echo \"Binary: \$CHROME\"
        echo \"Version: \$(\$CHROME --version)\"
        echo ''
        echo 'Fetching example.com...'
        timeout 15 \$CHROME --headless --disable-gpu --dump-dom https://example.com 2>/dev/null | head -5
        echo ''
        echo 'âœ“ Browser is working'
    "
}

cmd_help() {
    cat << EOF
${BOLD}openclaw-rpi${NC} v${VERSION} â€” Provision a Raspberry Pi as an OpenClaw AI agent

${BOLD}USAGE${NC}
    openclaw-rpi <command> [ip-address] [options]

${BOLD}COMMANDS${NC}
    flash                Interactive SD card flashing guide
    provision <ip>       Install all dependencies on the Pi
    configure <ip>       Interactive OpenClaw configuration
    verify <ip>          Health check â€” verify everything works
    setup <ip>           Full pipeline: provision + configure + verify
    ssh <ip>             SSH into the Pi
    status <ip>          Check OpenClaw and system status
    logs <ip>            Tail OpenClaw logs
    update <ip>          Update OpenClaw + system packages
    browser-test <ip>    Test headless Chromium
    help                 Show this help

${BOLD}ENVIRONMENT${NC}
    PI_USER              SSH username (default: pi)
    PI_HOSTNAME          Pi hostname (default: openclaw-pi)
    SKIP_DOCKER=1        Skip Docker installation
    INSTALL_OLLAMA=1     Opt-in to install Ollama for local models
    OLLAMA_MODELS        Space-separated models to pull (if Ollama enabled)

${BOLD}EXAMPLES${NC}
    openclaw-rpi setup 192.168.1.100
    PI_USER=jeremy openclaw-rpi provision 10.0.0.50
    SKIP_OLLAMA=1 openclaw-rpi provision 192.168.1.100
EOF
}

# â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CMD="${1:-help}"
shift || true

case "$CMD" in
    flash)        cmd_flash ;;
    provision)    require_ip "${1:-}"; cmd_provision "$1" ;;
    configure)    require_ip "${1:-}"; cmd_configure "$1" ;;
    verify)       require_ip "${1:-}"; cmd_verify "$1" ;;
    setup)        require_ip "${1:-}"; cmd_setup "$1" ;;
    ssh)          require_ip "${1:-}"; cmd_ssh "$1" ;;
    status)       require_ip "${1:-}"; cmd_status "$1" ;;
    logs)         require_ip "${1:-}"; cmd_logs "$1" ;;
    update)       require_ip "${1:-}"; cmd_update "$1" ;;
    browser-test) require_ip "${1:-}"; cmd_browser_test "$1" ;;
    help|--help|-h) cmd_help ;;
    version|--version|-v) echo "openclaw-rpi v${VERSION}" ;;
    *)
        err "Unknown command: $CMD"
        cmd_help
        exit 1
        ;;
esac
